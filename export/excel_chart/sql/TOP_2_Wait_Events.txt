WITH SNAP_DATE AS (SELECT SNAP_ID, DBID, INSTANCE_NUMBER
                     FROM DBA_HIST_SNAPSHOT
                    WHERE BEGIN_INTERVAL_TIME >= TO_DATE( '#(StartDate)' , 'YYYY-MM-DD' )
                      AND END_INTERVAL_TIME < TO_DATE( '#(EndDate)' , 'YYYY-MM-DD' )
),
SYSSTAT AS (SELECT A.DBID, A.INSTANCE_NUMBER, A.STAT_NAME,
				   MAX(A.VALUE) KEEP(DENSE_RANK LAST ORDER BY A.SNAP_ID) - MIN(VALUE) KEEP(DENSE_RANK FIRST ORDER BY A.SNAP_ID) VAL
			  FROM DBA_HIST_SYSSTAT A, SNAP_DATE B
			 WHERE A.SNAP_ID = B.SNAP_ID
			   AND A.DBID = B.DBID
			   AND A.STAT_NAME IN ('user commits', 'user rollbacks', 'DB time')
GROUP BY A.DBID, A.INSTANCE_NUMBER, A.STAT_NAME
)
SELECT X.INSTANCE_NUMBER,
	   X.EVENT_NAME "Event",
	   X.WAITS "Waits",
	   DECODE(X.WAITS,0,0,ROUND(X.TIME_OUTS*100/X.WAITS)) "%Time -outs",
	   DECODE(X.WAITS,0,0,ROUND(X.WAIT_TIME/X.WAITS/1000,2))|| 'ms' "Avg wait",
	   --ROUND(X.TIME_OUTS*100/X.WAITS) "%Time -outs",
	   ROUND(X.WAIT_TIME/1000000) "Total Wait Time (s)",
	   --ROUND(X.WAIT_TIME/X.WAITS/1000,2) || 'ms' "Avg wait",
	   ROUND(X.WAITS/Y.VAL,2) "Waits /txn"
	   --ROUND(X.WAIT_TIME/1000/Z.VAL*100,2) "% DB TIME"
FROM (SELECT A.DBID, A.INSTANCE_NUMBER, A.EVENT_NAME,
			 MAX(A.TOTAL_WAITS_FG) KEEP(DENSE_RANK LAST ORDER BY A.SNAP_ID) - MIN(A.TOTAL_WAITS_FG) KEEP(DENSE_RANK FIRST ORDER BY A.SNAP_ID) WAITS,
			 ROUND((MAX(A.TOTAL_TIMEOUTS_FG) KEEP(DENSE_RANK LAST ORDER BY A.SNAP_ID) - MIN(A.TOTAL_TIMEOUTS_FG) KEEP(DENSE_RANK FIRST ORDER BY A.SNAP_ID))) TIME_OUTS,
			 MAX(A.TIME_WAITED_MICRO_FG) KEEP(DENSE_RANK LAST ORDER BY A.SNAP_ID) - MIN(A.TIME_WAITED_MICRO_FG) KEEP(DENSE_RANK FIRST ORDER BY A.SNAP_ID) WAIT_TIME
		FROM DBA_HIST_SYSTEM_EVENT A, SNAP_DATE B
	   WHERE A.SNAP_ID = B.SNAP_ID
		 AND A.DBID = B.DBID
		 AND A.EVENT_NAME = '#(EVENT_NAME)'  --parameter 3
	  GROUP BY A.DBID, A.INSTANCE_NUMBER, A.EVENT_NAME) X,
	 (SELECT DBID, INSTANCE_NUMBER, 'txn_cnt', SUM(VAL) VAL
		FROM SYSSTAT
	   WHERE STAT_NAME IN ('user commits', 'user rollbacks')
	  GROUP BY DBID, INSTANCE_NUMBER, 'txn_cnt') Y,
	 (SELECT DBID, INSTANCE_NUMBER, STAT_NAME, VAL
		FROM SYSSTAT
	   WHERE STAT_NAME = 'DB time') Z
WHERE X.DBID = Y.DBID
AND X.DBID = Z.DBID
AND X.INSTANCE_NUMBER = Y.INSTANCE_NUMBER
AND X.INSTANCE_NUMBER = Z.INSTANCE_NUMBER