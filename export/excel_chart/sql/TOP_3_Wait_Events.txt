SELECT A.INSTANCE_NUMBER "INSTANCE_NUMBER",
	   A.SQL_ID "SQL_ID",
       A.SQL_PLAN_HASH_VALUE "Plan Hash Value",
       A.EVENT "Event",
       A.SQL_OPNAME "TOP ROW SOURCE",
       MAX(DBMS_LOB.SUBSTR( B.SQL_TEXT , 100 , 1 )) AS "SQL_TEXT"
FROM DBA_HIST_ACTIVE_SESS_HISTORY A, DBA_HIST_SQLTEXT B, DBA_HIST_SNAPSHOT C
WHERE A.SNAP_ID = C.SNAP_ID
AND A.DBID = C.DBID
AND A.INSTANCE_NUMBER = C.INSTANCE_NUMBER
AND A.SESSION_TYPE = 'FOREGROUND'
AND A.DBID = B.DBID
AND A.SQL_ID = B.SQL_ID
AND C.BEGIN_INTERVAL_TIME >= TO_DATE( '#(StartDate)' , 'YYYY-MM-DD' )
AND C.END_INTERVAL_TIME < TO_DATE( '#(EndDate)' , 'YYYY-MM-DD' )
AND A.event = '#(EVENT_NAME)' --parameter 3
GROUP BY A.INSTANCE_NUMBER, A.SQL_ID, A.SQL_PLAN_HASH_VALUE, A.EVENT, A.SQL_OPNAME
ORDER BY A.INSTANCE_NUMBER, SUM(WAIT_TIME) DESC